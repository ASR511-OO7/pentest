import random
import sys

from mitmproxy.flow import FlowWriter
from netlib.http import decoded


def start(context, argv):
    if len(argv) != 2:
        raise ValueError('Usage: -s "flowriter.py filename"')

    global f

    if argv[1] == "-":
        f = sys.stdout
    else:
        f = open(argv[1], "w", 0)
    context.flow_writer = FlowWriter(f)


def request(context, flow):
    with decoded(flow.request):
        if flow.request.method == "POST":
            context.flow_writer.add(flow.request)
            f.write("\n\nurl: " + flow.request.pretty_url)
            f.write("\npost data: " + flow.request.content)
            f.write("\n----------------------------------------------\n")

def done(context, argv):
    f.close
